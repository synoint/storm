files:
  "/etc/httpd/conf.d/symfony_rewrite.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      <VirtualHost *:80>
          DocumentRoot /var/app/current/public

          <Directory /var/app/current/public>
              DirectoryIndex index.php

              <IfModule mod_negotiation.c>
                  Options -MultiViews
              </IfModule>

              <IfModule mod_rewrite.c>
                  RewriteEngine On

                  # force redirect to HTTPS
                  RewriteCond %{HTTP:X-Forwarded-Proto} =http
                  RewriteRule .* https://%{HTTP:Host}%{REQUEST_URI} [L,R=permanent]

                  RewriteCond %{REQUEST_URI}::$1 ^(/.+)/(.*)::\2$
                  RewriteRule ^(.*) - [E=BASE:%1]

                  RewriteCond %{HTTP:Authorization} .
                  RewriteRule ^ - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

                  RewriteCond %{ENV:REDIRECT_STATUS} ^$
                  RewriteRule ^index\.php(?:/(.*)|$) %{ENV:BASE}/$1 [R=301,L]

                  RewriteCond %{REQUEST_FILENAME} -f
                  RewriteRule ^ - [L]

                  # Rewrite all other queries to the front controller.
                  RewriteRule ^ %{ENV:BASE}/index.php [L]
              </IfModule>

              <IfModule !mod_rewrite.c>
                  <IfModule mod_alias.c>
                      # When mod_rewrite is not available, we instruct a temporary redirect of
                      # the start page to the front controller explicitly so that the website
                      # and the generated links can still be used.
                      RedirectMatch 307 ^/$ /index.php/
                      # RedirectTemp cannot be used instead
                  </IfModule>
              </IfModule>

              # Allow loading fonts from CDN
              <FilesMatch "\.(ttf|otf|eot|woff|woff2)$">
                  <IfModule mod_headers.c>
                      Header Set Access-Control-Allow-Origin "*"
                  </IfModule>
              </FilesMatch>

              # Enable compression
              <IfModule mod_deflate.c>
                  <IfModule mod_filter.c>
                      AddOutputFilterByType DEFLATE "application/javascript" \
                                                    "application/json" \
                                                    "application/x-font-ttf" \
                                                    "application/x-javascript" \
                                                    "application/x-web-app-manifest+json" \
                                                    "font/eot" \
                                                    "font/opentype" \
                                                    "font/otf" \
                                                    "image/svg+xml" \
                                                    "text/cache-manifest" \
                                                    "text/calendar" \
                                                    "text/css" \
                                                    "text/html" \
                                                    "text/javascript" \
                                                    "text/plain" \
                                                    "text/markdown"
                  </Ifmodule>
              </Ifmodule>


              AllowOverride None
              Require all granted
          </Directory>

      </VirtualHost>
